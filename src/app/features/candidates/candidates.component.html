<div class="page-wrap">
  <div class="page-shell">

    <div class="head-row">
      <h2 class="title">Candidates</h2>
      <div class="actions">
        <input class="search" type="text" placeholder="Search..." (input)="onSearch($event.target.value)" />
        <button class="btn mint" type="button" (click)="openAdd()">+ Add</button>
      </div>
    </div>

    <div class="table glassy">
      <div class="row thead">
        <div class="th">ID</div>
        <div class="th">Name</div>
        <div class="th">Email</div>
        <div class="th">Department</div>
        <div class="th">Status</div>
        <div class="th right">Actions</div>
      </div>

      <ng-container *ngIf="rows && rows.length; else empty">
        <div class="row tr" *ngFor="let c of rows; trackBy: trackById">
          <div class="td">{{ c.id }}</div>
          <div class="td">{{ c.name || 'â€”' }}</div>
          <div class="td">{{ c.email || 'â€”' }}</div>
          <div class="td">{{ c.departmentName || 'â€”' }}</div>
          <div class="td">
            <span class="badge"
              [ngClass]="{
                applied: (c.status || '').toLowerCase() === 'applied',
                interview: (c.status || '').toLowerCase() === 'interview',
                hired: (c.status || '').toLowerCase() === 'hired',
                rejected: (c.status || '').toLowerCase() === 'rejected'
              }">{{ c.status || 'â€”' }}</span>
          </div>
          <div class="td right">
            <button class="icon-pill primary" type="button" (click)="openEdit(c)">âœŽ</button>
            <button class="icon-pill danger" type="button" (click)="delete(c)">ðŸ—‘</button>
          </div>
        </div>
      </ng-container>

      <ng-template #empty>
        <div class="row tr">
          <div class="td" style="grid-column:1 / -1; opacity:.7; padding:16px;">
            No candidates found.
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="modalOpen" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-head">
      <h3 class="modal-title">{{ modalMode === 'add' ? 'Add Candidate' : 'Edit Candidate' }}</h3>
    </div>

    <!-- IMPORTANT: we submit and also call saveForm on button click -->
    <form #formRef="ngForm" (ngSubmit)="saveForm()" class="modal-body" novalidate>
      <div class="form-row">
        <label>Name</label>
        <input class="field" type="text" name="name" [(ngModel)]="formCandidate.name" required />
      </div>

      <div class="form-row">
        <label>Email</label>
        <input class="field" type="email" name="email"
               [(ngModel)]="formCandidate.email" [pattern]="emailRegex" />
        <small class="hint" *ngIf="formRef.submitted && formCandidate.email && !String(formCandidate.email).match(emailRegex)">
          Please enter a valid email (example@domain.com).
        </small>
      </div>

      <div class="form-row">
        <label>Department</label>
        <select class="field" name="departmentId" [(ngModel)]="formCandidate.departmentId">
          <option *ngFor="let d of departments" [ngValue]="d.id">{{ d.name }}</option>
        </select>
      </div>

      <div class="form-row">
        <label>Status</label>
        <select class="field" name="status" [(ngModel)]="formCandidate.status" required>
          <option>Applied</option>
          <option>Interview</option>
          <option>Hired</option>
          <option>Rejected</option>
        </select>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn" (click)="closeModal()">Cancel</button>
        <!-- Dual path: submit the form AND call saveForm() as a safety net -->
        <button type="submit"
                class="btn mint"
                [disabled]="modalSaving || formRef.invalid"
                (click)="!modalSaving && !formRef.invalid && saveForm()">
          {{ modalMode === 'add' ? 'Create' : 'Save' }}
        </button>
      </div>
    </form>
  </div>
</div>
